/***************************************************************************//**
* \file cy_imagesensor.c
* \version 1.0
*
* Implements Image Sensor initializetion & configuration functions
*
*******************************************************************************
* \copyright
* (c) (2025), Cypress Semiconductor Corporation (an Infineon company) or
* an affiliate of Cypress Semiconductor Corporation.
*
* SPDX-License-Identifier: Apache-2.0
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*     http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*******************************************************************************/

#if MIPI_SOURCE_ENABLE

#include "usb_imagesensor.h"
#include "usb_app.h"
#include "usb_i2c.h"
#include "cy_lvds.h"
#include "usb_uvc_device.h"

#define SENSOR_I2C_ADDRESS_WIDTH            (2)
#define SENSOR_I2C_DATA_WIDTH               (1)

/* Sensor configuraton status */
bool glIsSensorConfigured = false;
#define SENSOR_SLAVE_ADDR                   (0x10)

const cy_stc_sensorConfig_t arraySensorInit_rpcamv2[] ={
    {0x0100, 0x0000},
    {0x30EB, 0x0005},
    {0x30EB, 0x000C},
    {0x300A, 0x00FF},
    {0x300B, 0x00FF},
    {0x30EB, 0x0005},
    {0x30EB, 0x0009},
    {0x0114, 0x0001},
    {0x0128, 0x0000},
    {0x012A, 0x0018},
    {0x012B, 0x0000},
    {0x0160, 0x0004},
    {0x0161, 0x0059},
    {0x0162, 0x000D},
    {0x0163, 0x0078},
    {0x0164, 0x0002},
    {0x0165, 0x00A8},
    {0x0166, 0x000A},
    {0x0167, 0x0027},
    {0x0168, 0x0002},
    {0x0169, 0x00B4},
    {0x016A, 0x0006},
    {0x016B, 0x00EB},
    {0x016C, 0x0007},
    {0x016D, 0x0080},
    {0x016E, 0x0004},
    {0x016F, 0x0038},
    {0x0170, 0x0001},
    {0x0171, 0x0001},
    {0x0174, 0x0000},
    {0x0175, 0x0000},
    {0x018C, 0x000A},
    {0x018D, 0x000A},
    {0x0301, 0x0005},
    {0x0303, 0x0001},
    {0x0304, 0x0003},
    {0x0305, 0x0003},
    {0x0306, 0x0000},
    {0x0307, 0x0039},
    {0x0309, 0x000A},
    {0x030B, 0x0001},
    {0x030C, 0x0000},
    {0x030D, 0x0072},
    {0x455E, 0x0000},
    {0x471E, 0x004B},
    {0x4767, 0x000F},
    {0x4750, 0x0014},
    {0x4540, 0x0000},
    {0x47B4, 0x0014},
    {0x4713, 0x0030},
    {0x478B, 0x0010},
    {0x478F, 0x0010},
    {0x4793, 0x0010},
    {0x4797, 0x000E},
    {0x479B, 0x000E},
    {0x0100, 0x0001},
    {0x0157, 0x0000},
    {0x0160, 0x0006},
    {0x0161, 0x00E3},
    {0x0162, 0x000D},
    {0x0163, 0x0078},
    {0x015A, 0x0004},
    {0x015B, 0x0022},
    {0x0157, 0x0000},
    {0x0160, 0x0006},
    {0x0161, 0x00E3},
    {0x0162, 0x000D},
    {0x0163, 0x0078},
    {0x015A, 0x0004},
    {0x015B, 0x006C},
    {0x0157, 0x00c0},
    {0x0160, 0x0006},
    {0x0161, 0x00E3},
    {0x0162, 0x000D},
    {0x0163, 0x0078},
    {0x015A, 0x0004},
    {0x015B, 0x0054},
    {0x0157, 0x00C0},
    {0x0172, 0x0003},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000},
    {0x0000, 0x0000}
};

/* Sensor settings - 1920x1080 */
const cy_stc_sensorConfig_t array1080p_pcam5c[] ={
    {0x3008, 0x42},
    {0x3103, 0x03},
    {0x3017, 0x00},
    {0x3018, 0x00},
    {0x3034, 0x18},
    {0x3035, 0x11},
    {0x3036, 0x54},
    {0x3037, 0x13},
    {0x3108, 0x01},
    {0x3820, 0x47},
    {0x3821, 0x00},
    {0x3814, 0x11},
    {0x3815, 0x11},
    {0x3800, 0x01},
    {0x3801, 0x50},
    {0x3802, 0x01},
    {0x3803, 0xB2},
    {0x3804, 0x08},
    {0x3805, 0xEF},
    {0x3806, 0x05},
    {0x3807, 0xF1},
    {0x3808, 0x07},
    {0x3809, 0x80},
    {0x380A, 0x04},
    {0x380B, 0x38},
    {0x380C, 0x09},
    {0x380D, 0xC4},
    {0x380E, 0x04},
    {0x380F, 0x60},
    {0x3810, 0x00},
    {0x3811, 0x10},
    {0x3812, 0x00},
    {0x3813, 0x04},
    {0x3618, 0x04},
    {0x3612, 0x2B},
    {0x3708, 0x64},
    {0x3709, 0x12},
    {0x370C, 0x00},
    {0x3A02, 0x04},
    {0x3A03, 0x60},
    {0x3A08, 0x01},
    {0x3A09, 0x50},
    {0x3A0A, 0x01},
    {0x3A0B, 0x18},
    {0x3A0E, 0x03},
    {0x3A0D, 0x04},
    {0x3A14, 0x04},
    {0x3A15, 0x60},
    {0x3002, 0x1C},
    {0x3006, 0xC3},
    {0x300E, 0x45},
    {0x302E, 0x08},
    {0x4300, 0x30},
    {0x501F, 0x00},
    {0x4713, 0x02},
    {0x4407, 0x04},
    {0x460B, 0x37},
    {0x460C, 0x20},
    {0x4827, 0x16},
    {0x3824, 0x04},
    {0x3008, 0x02},

};

/* Sensor settings - 640x480 */
const cy_stc_sensorConfig_t arrayVga_pcam5c[] =
{
    {0x3008, 0x42},
    {0x3103, 0x03},
    {0x3035, 0x14},
    {0x3036, 0x80},
    {0x3037, 0x13},
    {0x3108, 0x01},
    {0x3820, 0x47},
    {0x3821, 0x00},
    {0x3814, 0x31},
    {0x3815, 0x31},
    {0x3800, 0x00},
    {0x3801, 0x00},
    {0x3802, 0x00},
    {0x3803, 0x04},
    {0x3804, 0x0a},
    {0x3805, 0x3f},
    {0x3806, 0x07},
    {0x3807, 0x9b},
    {0x3808, 0x02},
    {0x3809, 0x80},
    {0x380a, 0x01},
    {0x380b, 0xe0},
    {0x380c, 0x07},
    {0x380d, 0x68},
    {0x380e, 0x08},
    {0x380f, 0xc8},
    {0x3810, 0x00},
    {0x3811, 0x10},
    {0x3812, 0x00},
    {0x3813, 0x06},
    {0x3618, 0x00},
    {0x3612, 0x29},
    {0x3708, 0x66},
    {0x3709, 0x12},
    {0x370c, 0x03},
    {0x3a02, 0x03},
    {0x3a03, 0xd8},
    {0x3a08, 0x01},
    {0x3a09, 0x27},
    {0x3a0a, 0x00},
    {0x3a0b, 0xf6},
    {0x3a0e, 0x03},
    {0x3a0d, 0x04},
    {0x3a14, 0x03},
    {0x3a15, 0xd8},
    {0x300e, 0x45},
    {0x302e, 0x08},
    {0x4300, 0x30},
    {0x501f, 0x00},
    {0x460c, 0x22},
    {0x3824, 0x02},
    {0x5001, 0xa3},
    {0x3008, 0x02},
};

/**
 * \name Cy_UVC_SendI2cTable
 * \brief I2C writes to image sensor
 * \param sensorConfig pointer to sesnofr configuration table
 * \param count number of I2C writes in the configuration table
 * \retval None
 */
void Cy_UVC_SendI2cTable(const cy_stc_sensorConfig_t *sensorConfig, uint32_t count)
{
    cy_en_scb_i2c_status_t status = CY_SCB_I2C_SUCCESS;
    uint32_t looper;
    uint16_t regAdd = 0;
    uint8_t  regValue = 0;

    for(looper = 0; looper < count; looper++)
    {
        regAdd   = sensorConfig[looper].sensorAddr;
        regValue = sensorConfig[looper].sensorVal;
        status = Cy_I2C_Write(SENSOR_SLAVE_ADDR, regAdd, regValue,SENSOR_I2C_ADDRESS_WIDTH,SENSOR_I2C_DATA_WIDTH);
    
        ASSERT_NON_BLOCK(CY_SCB_I2C_SUCCESS == status, status);
        if (status != CY_SCB_I2C_SUCCESS)
        {
            glIsSensorConfigured = false;
            DBG_APP_INFO("PCAMV2 Sensor Config failed \n\r");           
            break;
        }
    }

}/*End of Cy_UVC_SendI2cTable()*/

/**
 * \name Cy_UVC_ImageSensorInit
 * \brief Initialize image sensor 
 * \retval None
 */
void Cy_UVC_ImageSensorInit(void)
{
    uint32_t count = 0;
    
    count = sizeof(arraySensorInit_rpcamv2)/sizeof(cy_stc_sensorConfig_t);
    Cy_UVC_SendI2cTable(arraySensorInit_rpcamv2,count);
}/*End of Cy_UVC_ImageSensorInit()*/

/**
 * \name Cy_UVC_ImageSensorSetResolution
 * \brief This function Sets video resolution 
 * \param width Video width (in pixels)
 * \param height Video height (in pixels)
 * \retval None
 */
void Cy_UVC_ImageSensorSetResolution(uint32_t width,uint32_t height)
{
    uint32_t count = 0;

    DBG_APP_INFO("Resolution %d x %d\r\n",width,height);

    if((width == H_RES_1920) && (height == V_RES_1080))
    {
        count = sizeof(arraySensorInit_rpcamv2)/sizeof(cy_stc_sensorConfig_t);
        Cy_UVC_SendI2cTable(arraySensorInit_rpcamv2,count);

    }

    else if((width == H_RES_640) && (height == V_RES_480))
    {
        count = sizeof(arrayVga_pcam5c)/sizeof(cy_stc_sensorConfig_t);
        Cy_UVC_SendI2cTable(arrayVga_pcam5c,count);

    }
    else
    {
        LOG_ERROR("Error:Unsupported resolution.Try 1920x1080, 1280x720 or 640x480\r\n");
    }
}

/**
 * \name Cy_UVC_ConfigureImageSensor
 * \brief This function configures image sensor
 * \retval None
 */
void Cy_UVC_ConfigureImageSensor(void)
{
    glIsSensorConfigured = true;

    DBG_APP_INFO("Configure Image Sensor \n\r");
    Cy_LVDS_PhyGpioClr(LVDSSS_LVDS, PCAMV2_POWER_PORT, PCAMV2_POWER_PIN);
    Cy_SysLib_Delay(100);   
    Cy_LVDS_PhyGpioSet(LVDSSS_LVDS, PCAMV2_POWER_PORT, PCAMV2_POWER_PIN);
    Cy_SysLib_Delay(100);   
    
    Cy_UVC_ImageSensorInit();
    /* pcam v2 works on 1080p */
    Cy_UVC_ImageSensorSetResolution(H_RES_1920, V_RES_1080);
}

#endif /* MIPI_SOURCE_ENABLE */
